# TransLearn 代码审查与开发计划

> 生成时间: 2025-11-17
> 项目版本: v1.0.0
> 分析范围: 完整代码库

---

## 📋 目录

1. [未完成的功能](#1-未完成的功能)
2. [逻辑未闭环的部分](#2-逻辑未闭环的部分)
3. [需要优化的部分](#3-需要优化的部分)
4. [详细开发计划](#4-详细开发计划)
5. [优先级建议](#5-优先级建议)

---

## 1. 未完成的功能

### 🔴 高优先级

#### 1.1 在线词典翻译器 (Online Dictionary Translator)
**文件位置**: `src/core/translator_factory.py:37-40`

**问题描述**:
- 配置文件中有 `translation.online_dict` 配置项
- `TranslatorType.ONLINE_DICT` 枚举已定义
- `SmartRouter` 会路由到在线词典
- 但实际实现缺失,当前降级到 AI 翻译

**影响**:
- 用户配置在线词典后无效
- 无法使用有道/金山等免费在线词典API
- 增加AI调用成本

**实现方案**:
```python
# 创建 src/core/online_dict_translator.py
class OnlineDictTranslator(TranslatorInterface):
    """在线词典翻译器(有道/金山等)"""

    async def translate(self, text, source_lang, target_lang):
        # 1. 根据配置选择提供商(youdao/iciba)
        # 2. 调用对应API
        # 3. 解析并返回结果
        pass
```

**预计工时**: 4-6小时

---

#### 1.2 发音功能UI集成
**文件位置**: `src/ui/popup_window.py:311-329`

**问题描述**:
- `_on_pronounce()` 方法已实现
- `PronunciationService` 已完成
- 但在 `_create_actions()` 中未创建发音按钮

**影响**:
- 用户无法通过UI触发发音
- 发音功能形同虚设

**修复方案**:
```python
# 在 _create_actions() 中添加:
pronounce_btn = self._create_action_button("🔊", "发音")
pronounce_btn.clicked.connect(self._on_pronounce)
layout.addWidget(pronounce_btn)
```

**预计工时**: 30分钟

---

#### 1.3 复习系统实现
**文件位置**: `src/data/models.py:36-43`, `src/data/repository.py:91-100`

**问题描述**:
- 数据库字段完整(next_review, last_review, ease_factor等)
- 已有 `get_review_list()` 查询方法
- 但缺少:
  - 复习UI界面
  - SM-2算法更新逻辑
  - 复习结果反馈机制
  - 复习提醒功能

**影响**:
- 词汇无法有效复习
- 熟练度追踪失效
- 学习效果大打折扣

**实现方案**:
1. 创建复习界面 `src/ui/review_window.py`
2. 实现SM-2算法 `src/core/review_algorithm.py`
3. 添加复习记录更新逻辑
4. 集成到主窗口

**预计工时**: 12-16小时

---

### 🟡 中优先级

#### 1.4 标签关联系统
**文件位置**: `src/data/models.py:47`, `src/data/tag_repository.py`

**问题描述**:
- Entry 表的 tags 字段是 Text 类型(存JSON)
- Tag 表独立存在
- 缺少 entry_tags 关联表
- TagRepository 存在但未被使用

**影响**:
- 标签管理不规范
- 无法批量操作标签
- 查询效率低

**优化方案**:
```python
# 添加关联表
class EntryTag(Base):
    __tablename__ = "entry_tags"
    entry_id = Column(Integer, ForeignKey('entries.id'))
    tag_id = Column(Integer, ForeignKey('tags.id'))
```

**预计工时**: 6-8小时

---

#### 1.5 导出功能
**文件位置**: `data/config.example.toml:102`

**问题描述**:
- 配置中有 `export_format = "csv"` 选项
- requirements.txt 包含 pandas 和 openpyxl
- 但没有导出功能实现

**实现方案**:
1. 创建 `src/services/export_service.py`
2. 支持导出格式: CSV, Excel, JSON, Anki
3. 在主窗口添加导出按钮
4. 支持筛选条件导出

**预计工时**: 8-10小时

---

#### 1.6 数据备份功能
**文件位置**: `data/config.example.toml:100-101`

**问题描述**:
- 配置中有备份选项
- 但无自动备份逻辑

**实现方案**:
1. 创建 `src/services/backup_service.py`
2. 支持自动定期备份(MySQL dump)
3. 备份文件管理(保留最近N份)
4. 手动备份/恢复功能

**预计工时**: 6-8小时

---

### 🟢 低优先级

#### 1.7 Ollama 本地AI支持
**文件位置**: `src/core/ai_translator.py`, `data/config.example.toml:40`

**问题描述**:
- 配置提到 ollama 作为 provider
- 但只实现了 openai 和 dashscope

**实现方案**:
```python
async def _translate_ollama(self, text, source_lang, target_lang):
    # 使用 httpx 调用本地 Ollama API
    # http://localhost:11434/api/generate
    pass
```

**预计工时**: 4-6小时

---

#### 1.8 系统托盘自定义图标
**文件位置**: `src/ui/tray_icon.py:28`

**问题描述**:
```python
# TODO: 替换为实际图标
```

**实现方案**:
1. 设计应用图标(ICO格式)
2. 添加到 `data/icons/` 目录
3. 加载自定义图标

**预计工时**: 2-3小时(含设计)

---

#### 1.9 完整单元测试
**文件位置**: `scripts/test_*.py`

**问题描述**:
- 只有简单的手动测试脚本
- 缺少 pytest 单元测试
- 代码覆盖率未知

**实现方案**:
1. 创建 `tests/` 目录
2. 为核心模块编写测试
3. 配置 pytest 和 coverage
4. 目标覆盖率 > 80%

**预计工时**: 20-30小时

---

#### 1.10 OCR 功能完善
**文件位置**: `src/core/ocr_extractor.py`, `requirements.txt:32-33`

**问题描述**:
- OCR 框架已就绪
- PaddleOCR 在 requirements.txt 中被注释
- 截图功能已实现
- 但需要更多测试和优化

**实现方案**:
1. 取消注释 paddleocr 依赖
2. 添加 OCR 语言选择
3. 优化识别准确率
4. 添加结果编辑功能

**预计工时**: 6-8小时

---

## 2. 逻辑未闭环的部分

### 🔴 高优先级问题

#### 2.1 熟练度更新机制缺失
**文件位置**: `src/data/models.py:36-37`

**问题**:
```python
familiarity = Column(Integer, default=0, comment="熟悉度 0-5")
proficiency = Column(Integer, default=0, comment="熟练度 0-100")
```
- 字段存在但从未更新
- 统计窗口使用这些字段但数据始终为0

**解决方案**:
1. 在复习系统中根据回答正确率更新
2. 根据查询频率自动调整
3. 允许用户手动标记

**影响**: 学习数据不准确,统计功能失效

---

#### 2.2 查询计数未实现
**文件位置**: `src/services/translation_service.py:167-169`

**问题**:
```python
def _should_auto_save(self, text: str) -> bool:
    count = self.entry_repo.get_query_count(text)
    return count >= config.features.auto_save_threshold
```
- `get_query_count()` 只查询已保存的entry
- 未保存的翻译查询次数未记录
- 自动保存功能无法正常工作

**解决方案**:
1. 添加 QueryLog 表记录所有查询
2. 或使用缓存的 hit_count 字段
3. 达到阈值时自动保存

---

#### 2.3 黑名单未应用
**文件位置**: `src/data/models.py:147-160`, `src/services/context_service.py`

**问题**:
- Blacklist 模型已定义
- 配置中有黑名单应用列表
- 但 context_service 没有过滤逻辑

**解决方案**:
```python
# 在 context_service.py 中添加:
def is_blacklisted(app_name: str) -> bool:
    # 查询数据库黑名单
    # 检查配置文件黑名单
    return app_name in blacklist
```

---

#### 2.4 统计数据不完整
**文件位置**: `src/data/models.py:89-108`

**问题**:
- `ai_tokens` 字段存在但未填充
- `study_duration` 未追踪
- `new_words` 计数逻辑可能不准确

**解决方案**:
1. 从AI API响应中提取token使用量
2. 添加会话时长追踪
3. 优化词条统计逻辑

---

### 🟡 中优先级问题

#### 2.5 缓存过期清理无调度
**文件位置**: `src/data/repository.py:191-198`

**问题**:
- `clean_expired()` 方法存在
- 但没有定时任务调用
- 过期缓存会一直占用空间

**解决方案**:
1. 添加后台定时任务
2. 或在应用启动时清理
3. 或达到最大缓存数时清理

---

#### 2.6 配置不支持热更新
**文件位置**: `src/utils/config_loader.py`

**问题**:
- 配置在启动时加载一次
- 修改配置需要重启应用
- 用户体验不佳

**解决方案**:
1. 添加配置文件监听
2. 或在设置界面提供"应用"按钮
3. 部分配置支持动态更新

---

#### 2.7 错误处理不统一
**文件位置**: 多处

**问题**:
- 有些错误只记录日志
- 有些返回友好提示
- 有些直接抛出异常
- 缺少统一的错误处理机制

**解决方案**:
1. 定义错误码体系
2. 创建统一异常处理器
3. 友好的用户提示

---

#### 2.8 异步音频播放问题
**文件位置**: `src/core/pronunciation.py:75-100`, `src/ui/popup_window.py:311-329`

**问题**:
```python
# popup_window.py
asyncio.create_task(service.pronounce(text, lang="en"))
```
- 在Qt主线程创建asyncio任务不规范
- 可能导致事件循环冲突

**解决方案**:
1. 使用QThread运行异步代码
2. 或使用 `loop.run_until_complete()` 在新线程
3. 参考 TranslationWorker 的实现

---

## 3. 需要优化的部分

### 🎯 性能优化

#### 3.1 数据库连接池优化
**文件位置**: `src/data/database.py`

**当前问题**:
- Session异常后可能未正确释放
- 没有连接超时重连机制
- 错误处理不够完善

**优化方案**:
```python
# 添加连接健康检查
def _check_connection(self):
    try:
        session.execute(text("SELECT 1"))
    except:
        self._reconnect()

# 改进上下文管理器
@contextmanager
def get_session(self):
    session = self.Session()
    try:
        yield session
        session.commit()
    except Exception as e:
        session.rollback()
        logger.error(f"数据库错误: {e}")
        raise
    finally:
        session.close()
```

---

#### 3.2 分页查询优化
**文件位置**: `src/data/repository.py:58-65`

**当前问题**:
```python
def get_all(self, limit: int = 100, offset: int = 0):
    # 硬编码limit,没有真正的分页
```

**优化方案**:
1. UI层实现真正的分页控件
2. 支持无限滚动加载
3. 大数据集使用游标分页

---

#### 3.3 缓存策略优化
**文件位置**: `src/data/repository.py:153-199`

**当前问题**:
- 只有时间过期,无LRU淘汰
- 没有缓存大小限制
- 可能无限增长

**优化方案**:
```python
# 添加缓存大小检查
def set(self, cache):
    # 检查缓存总大小
    if self._get_cache_size() > config.cache.max_size_mb:
        self._evict_lru()  # 淘汰最少使用
    # 然后添加新缓存
```

---

#### 3.4 并发控制
**文件位置**: `data/config.example.toml:105`

**当前问题**:
- 配置中有 `max_concurrent_translations = 3`
- 但代码中未实现并发限制
- 可能同时发起大量AI请求

**优化方案**:
```python
# 使用 asyncio.Semaphore
class TranslationService:
    def __init__(self):
        self._semaphore = asyncio.Semaphore(
            config.performance.max_concurrent_translations
        )

    async def translate(self, text):
        async with self._semaphore:
            # 执行翻译
```

---

### 🛠️ 代码质量优化

#### 3.5 Repository 基类抽象
**文件位置**: `src/data/repository.py`

**当前问题**:
- EntryRepository, CacheRepository 有重复代码
- 没有基类抽象通用方法

**优化方案**:
```python
class BaseRepository:
    def __init__(self, model_class):
        self.model = model_class

    def get_by_id(self, id):
        # 通用实现
        pass

    def save(self, entity):
        # 通用实现
        pass
```

---

#### 3.6 类型提示完善
**文件位置**: 多处

**当前问题**:
- 部分文件缺少类型提示
- 没有运行 mypy 检查

**优化方案**:
1. 为所有函数添加类型提示
2. 配置并运行 mypy
3. 修复类型错误

---

#### 3.7 API 重试机制
**文件位置**: `src/core/ai_translator.py`

**当前问题**:
- AI API 调用失败直接返回错误
- 网络临时故障导致翻译失败
- 用户体验差

**优化方案**:
```python
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10)
)
async def _translate_with_retry(self, text, source_lang, target_lang):
    # AI API 调用
```

---

### 💡 用户体验优化

#### 3.8 错误提示友好化
**文件位置**: 多处

**当前问题**:
- 很多错误直接显示技术异常信息
- 用户不知道如何处理

**优化示例**:
```python
# 当前:
return f"翻译失败: {str(e)}"

# 优化后:
return self._get_friendly_error_message(e)

def _get_friendly_error_message(self, error):
    if "API key" in str(error):
        return "❌ API密钥无效\n\n请在设置中检查您的API密钥配置"
    elif "timeout" in str(error):
        return "⏱️ 请求超时\n\n请检查网络连接或稍后重试"
    # ...
```

---

#### 3.9 窗口状态保存
**文件位置**: `src/ui/main_window.py`, `src/ui/popup_window.py`

**当前问题**:
- 窗口位置和大小不记忆
- 每次打开都是默认状态

**优化方案**:
1. 使用 QSettings 保存窗口状态
2. 启动时恢复位置和大小
3. 记住上次选中的标签页

---

#### 3.10 日志级别动态调整
**文件位置**: `src/utils/logger.py`, `data/config.example.toml:106`

**当前问题**:
- 配置中有 `log_level = "INFO"`
- 但实际未使用,始终输出所有级别

**优化方案**:
```python
# logger.py
from src.utils.config_loader import config

def setup_logger():
    logger.remove()
    logger.add(
        sys.stderr,
        level=config.performance.log_level,  # 使用配置
        # ...
    )
```

---

#### 3.11 UI 国际化支持
**文件位置**: 所有 UI 文件

**当前问题**:
- 所有文本硬编码为中文
- 不支持多语言

**优化方案**:
1. 使用 Qt 的翻译系统 (QTranslator)
2. 提取所有文本到 .ts 文件
3. 支持中文/英文切换

---

#### 3.12 内存管理优化
**文件位置**: `src/core/ocr_extractor.py`, `src/core/pronunciation.py`

**当前问题**:
- 临时文件删除可能失败
- 没有清理机制

**优化方案**:
```python
import atexit
from pathlib import Path

class TempFileManager:
    def __init__(self):
        self.temp_files = []
        atexit.register(self.cleanup_all)

    def cleanup_all(self):
        for f in self.temp_files:
            try:
                Path(f).unlink()
            except:
                pass
```

---

#### 3.13 Token 消耗追踪
**文件位置**: `src/data/models.py:100`, `src/core/ai_translator.py`

**问题**:
- DailyStat 有 `ai_tokens` 字段
- 但从未填充数据

**优化方案**:
```python
# 从API响应中提取
response = await client.chat.completions.create(...)
tokens_used = response.usage.total_tokens

# 更新统计
self.stats_repo.update_today_stats(
    ai_calls=1,
    ai_tokens=tokens_used
)
```

---

#### 3.14 学习时长追踪
**文件位置**: `src/data/models.py:97`

**问题**:
- `study_duration` 字段存在但未使用

**优化方案**:
1. 记录应用启动和关闭时间
2. 记录活动时间(有翻译操作)
3. 每日累计学习时长

---

#### 3.15 主线程DB操作优化
**文件位置**: `src/ui/main_window.py`, `src/ui/popup_window.py`

**问题**:
- 部分数据库操作在Qt主线程执行
- 可能导致UI卡顿

**优化方案**:
```python
# 使用 QThread 执行数据库操作
class DatabaseWorker(QThread):
    result_ready = pyqtSignal(list)

    def run(self):
        entries = self.repo.get_all()
        self.result_ready.emit(entries)
```

---

## 4. 详细开发计划

### 第一阶段: 核心功能补全 (预计 4-6 周)

#### Sprint 1: 在线词典 & 发音集成 (1周)
- [ ] 实现在线词典翻译器 (有道API)
- [ ] 发音按钮UI集成
- [ ] 测试和文档更新

**交付物**:
- `src/core/online_dict_translator.py`
- 更新的 popup_window.py
- API 文档

---

#### Sprint 2: 复习系统 (2-3周)
- [ ] 设计复习UI界面
- [ ] 实现 SM-2 算法
- [ ] 复习记录更新
- [ ] 复习提醒功能
- [ ] 熟练度自动更新

**交付物**:
- `src/ui/review_window.py`
- `src/core/review_algorithm.py`
- 更新的数据模型
- 单元测试

---

#### Sprint 3: 数据管理优化 (1周)
- [ ] 标签关联重构
- [ ] 导出功能实现
- [ ] 备份功能实现
- [ ] 查询计数修复

**交付物**:
- 重构的标签系统
- `src/services/export_service.py`
- `src/services/backup_service.py`

---

### 第二阶段: 逻辑闭环 (预计 2-3 周)

#### Sprint 4: 统计与追踪 (1周)
- [ ] Token 消耗追踪
- [ ] 学习时长追踪
- [ ] 熟练度更新机制
- [ ] 统计数据完善

**交付物**:
- 完善的统计功能
- 准确的学习数据

---

#### Sprint 5: 系统完善 (1-2周)
- [ ] 黑名单功能实现
- [ ] 缓存清理调度
- [ ] 配置热更新
- [ ] 异步处理优化

**交付物**:
- 完善的系统功能
- 优化的异步处理

---

### 第三阶段: 性能与质量 (预计 3-4 周)

#### Sprint 6: 性能优化 (1-2周)
- [ ] 数据库连接池优化
- [ ] 分页查询实现
- [ ] 缓存策略优化
- [ ] 并发控制实现
- [ ] API 重试机制

**交付物**:
- 性能测试报告
- 优化后的核心模块

---

#### Sprint 7: 代码质量 (1周)
- [ ] Repository 基类抽象
- [ ] 类型提示完善
- [ ] 代码重构
- [ ] MyPy 检查通过

**交付物**:
- 重构的代码库
- MyPy 类型检查报告

---

#### Sprint 8: 测试覆盖 (1周)
- [ ] 单元测试编写
- [ ] 集成测试
- [ ] 测试覆盖率 > 80%
- [ ] CI/CD 配置

**交付物**:
- 完整的测试套件
- 测试覆盖率报告
- CI 配置文件

---

### 第四阶段: 用户体验 (预计 2-3 周)

#### Sprint 9: UX 优化 (1-2周)
- [ ] 错误提示友好化
- [ ] 窗口状态保存
- [ ] 日志级别动态调整
- [ ] 内存管理优化
- [ ] 主线程优化

**交付物**:
- 优化的用户体验
- 用户手册更新

---

#### Sprint 10: 扩展功能 (1周)
- [ ] Ollama 本地AI支持
- [ ] 自定义托盘图标
- [ ] OCR 功能完善
- [ ] UI 国际化(可选)

**交付物**:
- 扩展功能实现
- 完整文档

---

## 5. 优先级建议

### 🔥 立即处理 (1-2周内)

1. **发音按钮集成** (30分钟) - 功能已实现,只需连接UI
2. **黑名单功能** (2-3小时) - 配置已就绪,添加过滤逻辑
3. **错误提示优化** (4-6小时) - 提升用户体验
4. **在线词典实现** (4-6小时) - 降低AI成本

**理由**: 这些问题影响用户体验,但修复成本低,ROI高

---

### ⚡ 高优先级 (2-4周内)

1. **复习系统** (12-16小时) - 核心学习功能
2. **熟练度更新** (6-8小时) - 学习数据准确性
3. **查询计数修复** (4-6小时) - 自动保存功能
4. **统计数据完善** (6-8小时) - Token和时长追踪

**理由**: 影响核心功能,需要较多开发时间,但价值高

---

### 📊 中优先级 (1-2个月内)

1. **导出功能** (8-10小时)
2. **备份功能** (6-8小时)
3. **标签系统重构** (6-8小时)
4. **性能优化** (10-15小时)
5. **单元测试** (20-30小时)

**理由**: 提升产品质量和长期可维护性

---

### 🎨 低优先级 (可选)

1. **Ollama支持** (4-6小时)
2. **自定义图标** (2-3小时)
3. **UI国际化** (20-30小时)
4. **OCR完善** (6-8小时)

**理由**: 锦上添花,非核心需求

---

## 6. 风险评估

### 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 复习算法复杂度高 | 高 | 中 | 使用成熟的SM-2实现,充分测试 |
| 异步处理与Qt冲突 | 中 | 低 | 参考现有TranslationWorker模式 |
| 数据库迁移问题 | 高 | 低 | 使用Alembic做版本管理,充分备份 |
| 性能优化效果不明显 | 中 | 中 | 先做性能测试,明确瓶颈 |

### 资源风险

| 风险 | 缓解措施 |
|------|----------|
| 开发时间不足 | 分阶段实施,优先核心功能 |
| 测试资源有限 | 自动化测试,逐步提高覆盖率 |
| 文档更新滞后 | 每个Sprint同步更新文档 |

---

## 7. 成功指标

### 功能完整性
- [ ] 所有未完成功能实现率 > 90%
- [ ] 逻辑闭环问题解决率 = 100%
- [ ] 核心优化项完成率 > 80%

### 代码质量
- [ ] 单元测试覆盖率 > 80%
- [ ] MyPy 类型检查通过率 = 100%
- [ ] 代码重复率 < 10%

### 性能指标
- [ ] 翻译响应时间 < 2秒
- [ ] UI 无明显卡顿
- [ ] 内存占用 < 200MB

### 用户体验
- [ ] 关键操作 < 3次点击
- [ ] 错误提示友好率 = 100%
- [ ] 窗口状态记忆率 = 100%

---

## 8. 总结

### 当前状态
- ✅ **核心功能完成度**: 85%
- ⚠️ **逻辑完整性**: 65%
- ⚠️ **代码质量**: 70%
- ✅ **可用性**: 80%

### 建议路线图

**短期目标 (1个月)**:
- 补全核心缺失功能(在线词典、发音UI、复习系统)
- 修复逻辑闭环问题
- 提升用户体验

**中期目标 (2-3个月)**:
- 性能优化
- 代码质量提升
- 完善测试覆盖

**长期目标 (3-6个月)**:
- 扩展功能
- 国际化支持
- 移动端适配(可选)

### 结论

TransLearn 是一个**设计良好、架构清晰**的项目,核心功能已基本实现。主要问题集中在:

1. **部分配置功能未实现**(在线词典、Ollama等)
2. **学习功能未闭环**(复习系统、熟练度追踪)
3. **代码需要优化**(性能、测试、错误处理)

按照本计划逐步实施,预计 **2-3个月** 可以达到生产级质量标准。

---

**文档版本**: v1.0
**最后更新**: 2025-11-17
**维护者**: Claude Code

---
