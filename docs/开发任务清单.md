# TransLearn 开发任务清单

> 基于代码审查生成的可执行任务清单
> 生成时间: 2025-11-17

---

## 📋 使用说明

- ✅ 已完成
- 🚧 进行中
- ⏸️ 暂停
- ❌ 已取消
- ⭐ 高优先级
- 📌 中优先级
- 💡 低优先级

---

## 🔥 立即处理 (本周)

### ⭐ P0 - 关键缺陷修复

- [ ] **发音按钮UI集成** (30分钟)
  - 文件: `src/ui/popup_window.py`
  - 任务: 在 `_create_actions()` 中添加发音按钮
  - 连接: `pronounce_btn.clicked.connect(self._on_pronounce)`
  - 测试: 点击按钮能正常发音

- [ ] **黑名单功能实现** (2-3小时)
  - 文件: `src/services/context_service.py`
  - 任务: 添加 `is_blacklisted()` 方法
  - 在翻译前检查来源应用
  - 测试: 黑名单应用不触发翻译

- [ ] **查询计数修复** (4-6小时)
  - 方案1: 创建 QueryLog 表
  - 方案2: 使用缓存 hit_count
  - 任务: 实现查询次数累计
  - 修复自动保存功能

---

## ⚡ 第一阶段: 核心功能补全 (2-4周)

### 📌 在线词典实现 (4-6小时)

- [ ] **创建在线词典翻译器**
  - 创建文件: `src/core/online_dict_translator.py`
  - 继承 `TranslatorInterface`
  - 实现 `translate()` 方法

- [ ] **有道词典API集成**
  - 注册有道API获取密钥
  - 实现API调用逻辑
  - 处理错误和限流

- [ ] **更新工厂类**
  - 修改: `src/core/translator_factory.py:37-40`
  - 移除降级逻辑,返回真实实现

- [ ] **测试与文档**
  - 编写单元测试
  - 更新API文档
  - 添加使用示例

---

### ⭐ 复习系统实现 (12-16小时)

#### 数据层 (4小时)

- [ ] **复习记录更新方法**
  - 文件: `src/data/repository.py`
  - 添加 `update_review_result()` 方法
  - 更新 last_review, next_review, proficiency

- [ ] **复习列表查询优化**
  - 优化 `get_review_list()` 性能
  - 添加排序和筛选

#### 业务逻辑 (4小时)

- [ ] **SM-2算法实现**
  - 创建: `src/core/review_algorithm.py`
  - 实现 `calculate_next_review()` 方法
  - 实现 `update_ease_factor()` 方法
  - 参考: https://en.wikipedia.org/wiki/SuperMemo#SM-2_algorithm

#### UI层 (4-6小时)

- [ ] **创建复习窗口**
  - 创建: `src/ui/review_window.py`
  - 卡片式复习界面
  - 显示问题和答案
  - 正确/错误/困难按钮

- [ ] **集成到主窗口**
  - 在主窗口添加"复习"标签页
  - 或添加"开始复习"按钮
  - 显示待复习数量

#### 测试 (2小时)

- [ ] **复习流程测试**
  - 测试SM-2算法正确性
  - 测试复习记录更新
  - 测试UI交互

---

### 📌 数据管理优化 (8-12小时)

#### 标签系统重构 (6-8小时)

- [ ] **创建关联表**
  - 修改: `src/data/models.py`
  - 添加 `EntryTag` 关联表
  - 建立多对多关系

- [ ] **迁移现有数据**
  - 编写数据迁移脚本
  - 将JSON标签转为关联表
  - 验证数据完整性

- [ ] **更新Repository**
  - 修改: `src/data/repository.py`
  - 实现标签的增删改查
  - 实现标签筛选查询

- [ ] **更新UI**
  - 修改标签选择界面
  - 支持多选标签
  - 标签管理界面

#### 导出功能 (8-10小时)

- [ ] **创建导出服务**
  - 创建: `src/services/export_service.py`
  - 实现 `export_to_csv()` 方法
  - 实现 `export_to_excel()` 方法
  - 实现 `export_to_json()` 方法
  - 实现 `export_to_anki()` 方法(可选)

- [ ] **导出UI**
  - 在主窗口添加导出按钮
  - 导出选项对话框(格式、筛选条件)
  - 进度提示

- [ ] **测试**
  - 测试各种格式导出
  - 测试大量数据导出
  - 验证导出文件格式

#### 备份功能 (6-8小时)

- [ ] **创建备份服务**
  - 创建: `src/services/backup_service.py`
  - 实现 `create_backup()` 方法
  - 实现 `restore_backup()` 方法
  - 实现 `list_backups()` 方法

- [ ] **定时备份**
  - 添加后台定时任务
  - 根据配置间隔自动备份
  - 保留最近N份备份

- [ ] **备份UI**
  - 在设置中添加备份选项卡
  - 手动备份/恢复按钮
  - 备份列表显示

---

## 🔧 第二阶段: 逻辑闭环 (2-3周)

### 📌 统计与追踪完善 (8-10小时)

- [ ] **Token消耗追踪**
  - 修改: `src/core/ai_translator.py`
  - 从API响应提取 token 数量
  - 更新 DailyStat.ai_tokens
  - 在统计界面显示

- [ ] **学习时长追踪**
  - 创建: `src/utils/activity_tracker.py`
  - 记录应用启动/关闭时间
  - 记录活动时间(有操作时)
  - 更新 DailyStat.study_duration

- [ ] **熟练度自动更新**
  - 根据复习结果更新
  - 根据查询频率调整
  - 长期未查看降低熟练度

- [ ] **统计数据完善**
  - 修复 new_words 计数逻辑
  - 确保所有统计字段正确填充
  - 优化统计查询性能

---

### 📌 系统功能完善 (6-8小时)

- [ ] **缓存清理调度**
  - 创建: `src/utils/scheduler.py`
  - 应用启动时清理过期缓存
  - 或每天定时清理
  - 达到大小限制时清理最旧

- [ ] **配置热更新**
  - 方案1: 文件监听 (watchdog)
  - 方案2: 设置界面"应用"按钮
  - 部分配置支持动态更新
  - 热键等需要重启的配置给出提示

- [ ] **异步处理优化**
  - 修改: `src/ui/popup_window.py:311-329`
  - 使用 QThread 运行异步发音
  - 避免事件循环冲突
  - 参考 TranslationWorker 实现

---

## ⚙️ 第三阶段: 性能优化 (2-3周)

### 📌 数据库优化 (6-8小时)

- [ ] **连接池优化**
  - 修改: `src/data/database.py`
  - 添加连接健康检查
  - 实现自动重连
  - 改进Session上下文管理

- [ ] **查询优化**
  - 添加必要的索引
  - 优化N+1查询问题
  - 使用延迟加载

- [ ] **分页实现**
  - UI层添加分页控件
  - 或实现无限滚动
  - 游标分页支持

---

### 📌 缓存策略优化 (4-6小时)

- [ ] **缓存大小限制**
  - 修改: `src/data/repository.py`
  - 检查缓存总大小
  - 实现LRU淘汰策略
  - 配置最大缓存容量

- [ ] **缓存预热**
  - 应用启动时加载常用词
  - 智能预测可能查询的词

---

### 📌 并发控制 (4-6小时)

- [ ] **翻译并发限制**
  - 修改: `src/services/translation_service.py`
  - 使用 asyncio.Semaphore
  - 限制并发AI请求数量
  - 请求队列管理

- [ ] **API重试机制**
  - 安装 tenacity 库
  - 添加指数退避重试
  - 配置最大重试次数
  - 区分可重试/不可重试错误

---

## 📝 第四阶段: 代码质量 (2-3周)

### 📌 代码重构 (8-10小时)

- [ ] **Repository基类抽象**
  - 创建: `src/data/base_repository.py`
  - 抽象通用CRUD方法
  - 重构现有Repository继承基类

- [ ] **类型提示完善**
  - 为所有函数添加类型提示
  - 安装并配置 mypy
  - 修复类型错误
  - 达到 mypy 检查通过

- [ ] **代码规范**
  - 运行 black 格式化
  - 配置 flake8
  - 修复 lint 警告

---

### 📌 单元测试 (20-30小时)

- [ ] **测试框架搭建**
  - 创建 `tests/` 目录
  - 配置 pytest
  - 配置 coverage

- [ ] **核心模块测试**
  - tests/test_translator.py
  - tests/test_repository.py
  - tests/test_review_algorithm.py
  - tests/test_translation_service.py

- [ ] **UI测试**
  - 使用 pytest-qt
  - 测试关键交互

- [ ] **测试覆盖率**
  - 目标: > 80%
  - 生成覆盖率报告
  - 持续集成

---

### 📌 CI/CD配置 (4-6小时)

- [ ] **GitHub Actions**
  - 创建 `.github/workflows/test.yml`
  - 自动运行测试
  - 自动检查代码质量

- [ ] **自动构建**
  - PyInstaller打包配置
  - 自动生成可执行文件
  - 版本发布流程

---

## 💡 第五阶段: 用户体验 (1-2周)

### 📌 错误处理优化 (6-8小时)

- [ ] **友好错误提示**
  - 创建: `src/utils/error_handler.py`
  - 定义错误码体系
  - 实现 `get_friendly_message()` 方法
  - 更新所有错误处理

- [ ] **错误上报**
  - 记录错误日志
  - 可选: Sentry集成

---

### 📌 UI优化 (8-10小时)

- [ ] **窗口状态保存**
  - 使用 QSettings
  - 保存窗口位置/大小
  - 保存选中的标签页
  - 启动时恢复

- [ ] **加载状态提示**
  - 翻译时显示加载动画
  - 长操作显示进度条
  - 禁用重复点击

- [ ] **快捷键提示**
  - 鼠标悬停显示快捷键
  - 添加快捷键说明页面

---

### 📌 内存优化 (4-6小时)

- [ ] **临时文件管理**
  - 创建: `src/utils/temp_file_manager.py`
  - 统一管理临时文件
  - 应用退出时清理
  - 定期清理旧文件

- [ ] **主线程优化**
  - 数据库操作移到工作线程
  - 使用 QThread 处理耗时任务
  - 避免UI卡顿

---

## 🎨 扩展功能 (可选)

### 💡 Ollama本地AI (4-6小时)

- [ ] **Ollama集成**
  - 修改: `src/core/ai_translator.py`
  - 添加 `_translate_ollama()` 方法
  - 支持本地模型调用
  - 测试多种模型

---

### 💡 自定义图标 (2-3小时)

- [ ] **图标设计**
  - 设计应用图标(PNG/SVG)
  - 转换为ICO格式
  - 生成不同尺寸

- [ ] **图标集成**
  - 添加到 `data/icons/` 目录
  - 修改: `src/ui/tray_icon.py:28`
  - 窗口图标更新

---

### 💡 OCR优化 (6-8小时)

- [ ] **PaddleOCR优化**
  - requirements.txt 取消注释
  - 添加语言选择(中文/英文/日文)
  - 优化识别准确率
  - 结果编辑功能

- [ ] **其他OCR引擎**
  - Tesseract集成(可选)
  - 百度/腾讯云OCR(可选)

---

### 💡 UI国际化 (20-30小时)

- [ ] **提取文本**
  - 使用 pylupdate6 提取翻译
  - 生成 .ts 文件

- [ ] **翻译**
  - 翻译为英文
  - 翻译为其他语言(可选)

- [ ] **集成**
  - 使用 QTranslator
  - 支持语言切换
  - 保存语言设置

---

## 📊 进度追踪

### 总体进度

- **立即处理**: 0/3 (0%)
- **第一阶段**: 0/35 (0%)
- **第二阶段**: 0/12 (0%)
- **第三阶段**: 0/15 (0%)
- **第四阶段**: 0/20 (0%)
- **第五阶段**: 0/12 (0%)
- **扩展功能**: 0/10 (0%)

**总计**: 0/107 (0%)

---

## 🎯 本周目标

### Week 1 (当前周)
- [ ] 发音按钮集成
- [ ] 黑名单功能
- [ ] 查询计数修复
- [ ] 在线词典实现(开始)

---

## ✅ 完成记录

_待开始..._

---

## 📝 备注

- 每完成一个任务,更新上方的进度
- 遇到问题及时记录
- 定期回顾和调整计划
- 优先完成高优先级任务

---

**文档版本**: v1.0
**创建时间**: 2025-11-17
**维护者**: 开发团队

---
